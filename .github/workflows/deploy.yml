name: 메모앱 CI/CD


on:
    push:
        branches:
            - main-cicd

            

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:        
            - name: 코드 Checkout
              uses: actions/checkout@v3

            - name: 검증
              run: |
                pwd
                ls -al
                cat requirements.txt
              shell: bash
 
            - name: 환경변수 파일(.env) 동적생성
              run: |
                echo "${{ secrets.APP_ENV }}" >> .env
                ls -al
                cat .env
              shell: bash
            
            - name: Copy sourcecode to Ec2
              uses: appleboy/scp-action@master
              with: 
                host: ${{ secrets.EC2_HOST }}
                username: ${{ secrets.EC2_USERNAME }}
                key: ${{ secrets.EC2_KEY }}
                port: 22
            
                source: .
                target: "/home/ubuntu/projects"


            - name: Run Script and Service Restart
              uses: appleboy/ssh-action@master
              with: 
                host: ${{ secrets.EC2_HOST }}
                username: ${{ secrets.EC2_USERNAME }}
                key: ${{ secrets.EC2_KEY }}
                port: 22
                script: |
                  # 1차로 ec2 세팅을 진행하고 나서 CI/CD 
                  # ec2에 접속하고 나서 진행할 업무 기술
                  # 해당 프로젝트 폴더로 이동(cd)
                  cd /home/ubuntu/projects

                  # 현재 프로젝트 내 파일을 확인
                  ls -al
                
                  # 추가(최초)로 설치된 패키지를 설치
                  # 가상환경을 구동하지 않고, 가상환경의 명령어 직접 사용 가상환경(web)
                  ./web/bin/pip install -r requirements.txt
                  # uvicorn 서비스를 재가동(재시작 : restart) -> sudo
                  sudo systemctl restart hello.service


